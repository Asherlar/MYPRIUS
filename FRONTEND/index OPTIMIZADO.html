<html>

  <head>

    <title>My Prius</title>
    <style>
      .backend-selector {
        margin: 10px;
        padding: 5px;
        display: none; /* Oculta el selector por defecto */
      }

    /* Posicionamiento común de ruedas */
    .rueda-delantera-red , .rueda-delantera-green {
        transform: translate(-13px,-8px);
    }
    .rueda-trasera-green , .rueda-trasera-red {
        transform: translate(-9px,-20px);
    }
    /* imagenes de cada rueda */
    .rueda-delantera-red {
        background-image: url('images/rd_red.jpg');
    }

    .rueda-delantera-green {
        background-image: url('images/rd_green.jpg');
    }
    
    .rueda-trasera-red {
        background-image: url('images/rt_red.jpg');
    }
    
    .rueda-trasera-green {
        background-image: url('images/rt_green.jpg');
    }
    </style>  

    <script> 
    // Funciones JS para manejar la UI y mostrar/ocultar formularios de ruedas.
      function ruedaDelantera() {
        document.getElementById("dela").style.display = "block";
        document.getElementById("tras").style.display = "none";
        document.getElementById("backendselector").style.display = "block"    //muestra selector backend
      }
      function ruedatrasera() {
        document.getElementById("tras").style.display = "block";
        document.getElementById("dela").style.display = "none";
        document.getElementById("backendselector").style.display = "block"   //muestra selector backend
      }
  

      // Funciones JS que reciben los KMs de cada rueda, hacen la petición al backend y actualizan la UI según la respuesta.
      function cambioPorKMsGeneral(parametroRuedas) {
        var varParaAlterarRuedaContraria = ""; 
        var varParaAlterarRuedaSenyalada = "";
        var kms;

        if (parametroRuedas === 'parametro_delantera') {
          varParaAlterarRuedaContraria = "rueTra";
          varParaAlterarRuedaSenyalada = "rueDel";
          kms = document.getElementsByName("kilometrosRuedaDelantera")[0].value;
        } else if (parametroRuedas === 'parametro_trasera') {
          varParaAlterarRuedaContraria = "rueDel";
          varParaAlterarRuedaSenyalada = "rueTra";
          kms = document.getElementsByName("kilometrosRuedaTrasera")[0].value;
        }         
        // Reseteamos el estado de la rueda contraria
        document.getElementById(varParaAlterarRuedaContraria).style.backgroundColor = "";
        document.getElementById(varParaAlterarRuedaContraria).innerHTML = "";
        

       // Petición a backend. la API fetch realiza la petición GET al endpoint del backend con los KMs como parámetro.
        var colorbackend;
        var msgbackend;
        // Se selecciona el backend al que enviar la petición según la opción elegida en el selector por el usuario.
        const backendtype = document.getElementById("backendselect").value;
        const baseurl = backendtype === "local"
            ? "http://127.0.0.1:8000/2/"
            : "http://16.170.250.46:8000/2/";
        alert('Enviando al backend: ' + kms);
       fetch(baseurl + kms) 
        // Procesamos la respuesta del backend en el formato JSON esperado mediante promesas
        // Las operaciones como fetch son asíncronas y permiten manejar la respuesta sin bloquear la UI
        // El primer then: procesa la respuesta HTTP
        .then(response => {
          if (!response.ok) {
            throw new Error('Error en la respuesta: ' + response.status);
          }
          return response.json();
        })
        // El segundo then: procesa los datos JSON
        .then(data => {
          console.log('Respuesta del servidor:', data);
          alert('Respuesta del servidor: ' + JSON.stringify(data));
          if (!data.hasOwnProperty('color')) {
            throw new Error('La respuesta no contiene la propiedad color');
          }
          if (!data.hasOwnProperty('msg')) {
            throw new Error('La respuesta no contiene la propiedad msg');
          }
          
          // Extraemos los datos del JSON
          colorbackend = data.color;
          msgbackend = data.msg;
          
          // Actualizamos la UI según el color y mensaje recibidos del backend
          // Cambiamos la clase CSS de la rueda señalada para actualizar su imagen
          if (colorbackend === "red") {
              if (parametroRuedas === 'parametro_delantera') {
              document.getElementById(varParaAlterarRuedaSenyalada).className = "rueda-delantera-red";
              document.getElementById("rdtext").innerHTML = msgbackend;
              document.getElementById("rdtext").style.color = "red";
            } else if (parametroRuedas === 'parametro_trasera') {
              document.getElementById(varParaAlterarRuedaSenyalada).className = "rueda-trasera-red";
              document.getElementById("rttext").innerHTML = msgbackend;
              document.getElementById("rttext").style.color = "red";
            }
          }else{
          
            if (parametroRuedas === 'parametro_delantera') {
              document.getElementById(varParaAlterarRuedaSenyalada).className = "rueda-delantera-green";
              document.getElementById("rdtext").innerHTML = msgbackend;
              document.getElementById("rdtext").style.color = "green";
              
            } else if (parametroRuedas === 'parametro_trasera') {
              document.getElementById(varParaAlterarRuedaSenyalada).className = "rueda-trasera-green";
              document.getElementById("rttext").innerHTML = msgbackend;
              document.getElementById("rttext").style.color = "green";
            }
        }
        });


     
      }  

    </script>
  </head>


  <body>

    <!-- Imagen del coche con las dos ruedas con áreas clicables -->
    <div style="background-image:url('images/PRIUS.jpg'); width: 600px; height: 300px;"> 
      
      <div id="rueDel" style="width: 97px; height: 97px; position: relative; left: 190px; top: 190px" onclick="ruedaDelantera()"></div>
      <div id="rueTra" style="width: 86px; height: 86px; position: relative; left: 490px; top: 100px" onclick="ruedatrasera()"></div>
    </div> 

    <!-- Selector de backend (oculto por defecto, se mostrará al clicar una rueda) -->
    <div class="backend-selector" id="backendselector">
      <label for="backendselect">Seleccione Backend:</label>
      <select id="backendselect">
          <option value="local">Local (127.0.0.1)</option>
          <option value="remoto">Remoto (16.170.250.46)</option>
      </select>
    </div>

    <!-- Formularios ocultos para cada rueda, para introducir los KMs y enviarlos al backend. -->
    <div id="dela" style="display: none;">
      <span id="rdtext">RUEDA DELANTERA</span> 
      <input type="number" name="kilometrosRuedaDelantera" value="">
      <button onclick="cambioPorKMsGeneral('parametro_delantera')">OK</button>
    </div>
    
    <div id="tras" style="display: none;">
      <span id="rttext">RUEDA TRASERA</span>
      <input type="number" name="kilometrosRuedaTrasera" value="">
      <button onclick="cambioPorKMsGeneral('parametro_trasera')">OK</button>
    </div>


  </body>


</html>